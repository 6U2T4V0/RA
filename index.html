<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Realidad Aumentada - TrÃ­ptico</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/aframe/1.4.0/aframe.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ar.js/2.2.2/aframe-ar.min.js"></script>
    <style>
        body {
            margin: 0;
            font-family: Arial, sans-serif;
            background: #000;
        }
        
        .instructions {
            position: fixed;
            top: 20px;
            left: 20px;
            right: 20px;
            background: rgba(0,0,0,0.8);
            color: white;
            padding: 20px;
            border-radius: 15px;
            z-index: 999;
            text-align: center;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255,255,255,0.2);
        }
        
        .instructions h2 {
            margin: 0 0 10px 0;
            color: #4CAF50;
            font-size: 24px;
        }
        
        .instructions p {
            margin: 10px 0;
            font-size: 16px;
            line-height: 1.4;
        }
        
        .camera-icon {
            font-size: 40px;
            margin: 10px 0;
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.1); }
            100% { transform: scale(1); }
        }
        
        .status {
            position: fixed;
            bottom: 20px;
            left: 20px;
            right: 20px;
            background: rgba(76, 175, 80, 0.9);
            color: white;
            padding: 15px;
            border-radius: 10px;
            text-align: center;
            font-weight: bold;
            display: none;
            z-index: 999;
            animation: slideUp 0.5s ease-out;
        }
        
        @keyframes slideUp {
            from { transform: translateY(100%); }
            to { transform: translateY(0); }
        }
        
        .status.error {
            background: rgba(244, 67, 54, 0.9);
        }
        
        .loading {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: white;
            font-size: 18px;
            z-index: 998;
            text-align: center;
        }
        
        .spinner {
            border: 3px solid rgba(255,255,255,0.3);
            border-top: 3px solid #4CAF50;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* Ocultar instrucciones cuando se detecte marcador */
        .marker-found .instructions {
            display: none;
        }
        
        a-scene {
            width: 100vw;
            height: 100vh;
        }
    </style>
</head>
<body>
    <div class="instructions" id="instructions">
        <h2>ðŸ“± Realidad Aumentada</h2>
        <div class="camera-icon">ðŸ“¹</div>
        <p><strong>Apunta tu cÃ¡mara hacia el marcador HIRO</strong></p>
        <p><small><a href="https://github.com/AR-js-org/AR.js/blob/master/data/images/hiro.png" target="_blank" style="color: #4CAF50;">Descargar marcador HIRO para probar</a></small></p>
    </div>
    
    <div class="loading" id="loading">
        <div class="spinner"></div>
        <p>Iniciando cÃ¡mara...</p>
    </div>
    
    <div class="status" id="status">
        Â¡Logotipo detectado! Reproduciendo video...
    </div>

    <!-- Escena AR optimizada -->
    <a-scene 
        vr-mode-ui="enabled: false" 
        renderer="logarithmicDepthBuffer: true; antialias: true; colorManagement: true"
        arjs="trackingMethod: best; sourceType: webcam; debugUIEnabled: false; detectionMode: mono_and_matrix; matrixCodeType: 3x3;"
        id="arScene">
        
        <a-assets>
            <!-- Video que se reproducirÃ¡ SOLO cuando se detecte el marcador -->
            <video 
                id="ar-video" 
                src="https://commondatastorage.googleapis.com/gtv-videos-bucket/sample/BigBuckBunny.mp4"
                preload="none"
                webkit-playsinline 
                playsinline
                crossorigin="anonymous"
                muted
                loop
                style="display: none;">
            </video>
        </a-assets>

        <!-- Marcador para TU logotipo -->
        <!-- OPCIÃ“N 1: Usar tu archivo .patt personalizado -->
        <!-- <a-marker type="pattern" url="tu-logotipo.patt" id="logoMarker" markerhandler> -->
        
        <!-- OPCIÃ“N 2: Marcador HIRO predefinido (PARA PROBAR AHORA) -->
        <a-marker 
            preset="hiro" 
            id="logoMarker"
            markerhandler>
            
            <!-- Video flotante sobre el logotipo (OCULTO por defecto) -->
            <a-plane 
                position="0 0.5 0" 
                rotation="-90 0 0" 
                width="3" 
                height="2"
                material="src: #ar-video; transparent: true; alphaTest: 0.5"
                animation__show="property: scale; from: 0 0 0; to: 1 1 1; dur: 800; easing: easeOutElastic"
                animation__float="property: position; from: 0 0.5 0; to: 0 0.7 0; dur: 2000; dir: alternate; loop: true; easing: easeInOutSine"
                visible="false"
                id="video-plane">
            </a-plane>
            
            <!-- Marco elegante -->
            <a-ring 
                position="0 0.5 0.01" 
                rotation="-90 0 0"
                radius-inner="1.8" 
                radius-outer="2"
                material="color: #4CAF50; transparent: true; opacity: 0.8"
                animation__rotate="property: rotation; from: -90 0 0; to: -90 0 360; dur: 10000; loop: true; easing: linear">
            </a-ring>
            
            <!-- PartÃ­culas decorativas -->
            <a-sphere 
                position="2 1 0" 
                radius="0.1" 
                material="color: #4CAF50; transparent: true; opacity: 0.7"
                animation__bounce="property: position; from: 2 1 0; to: 2 2 0; dur: 1500; dir: alternate; loop: true; easing: easeInOutQuad">
            </a-sphere>
            <a-sphere 
                position="-2 1 0" 
                radius="0.1" 
                material="color: #2196F3; transparent: true; opacity: 0.7"
                animation__bounce="property: position; from: -2 1 0; to: -2 2 0; dur: 1800; dir: alternate; loop: true; easing: easeInOutQuad">
            </a-sphere>
            
            <!-- Texto informativo -->
            <a-text 
                value="Â¡Contenido Activado!" 
                position="0 2.5 0" 
                align="center" 
                color="#4CAF50"
                scale="2 2 2"
                animation__pulse="property: scale; from: 2 2 2; to: 2.2 2.2 2.2; dur: 1000; dir: alternate; loop: true">
            </a-text>
        </a-marker>

        <!-- CÃ¡mara AR -->
        <a-entity camera arjs-camera="sourceType: webcam"></a-entity>
    </a-scene>

    <script>
        // Variables globales
        let isMarkerVisible = false;
        let video = null;
        let arScene = null;
        
        // InicializaciÃ³n cuando la pÃ¡gina carga
        document.addEventListener('DOMContentLoaded', function() {
            video = document.querySelector('#ar-video');
            arScene = document.querySelector('#arScene');
            
            // Ocultar loading cuando AR.js estÃ© listo
            setTimeout(() => {
                document.getElementById('loading').style.display = 'none';
            }, 3000);
        });
        
        // Componente personalizado para manejar el marcador
        AFRAME.registerComponent('markerhandler', {
            init: function () {
                const marker = this.el;
                const statusDiv = document.querySelector('#status');
                const instructionsDiv = document.querySelector('#instructions');
                const videoPlane = document.querySelector('#video-plane');
                
                // Cuando se detecta el logotipo
                marker.addEventListener('markerFound', function() {
                    console.log('Â¡Logotipo detectado!');
                    isMarkerVisible = true;
                    
                    // Mostrar estado
                    statusDiv.style.display = 'block';
                    statusDiv.className = 'status';
                    statusDiv.textContent = 'Â¡Logotipo detectado! Cargando video...';
                    
                    // Ocultar instrucciones
                    document.body.classList.add('marker-found');
                    
                    // Mostrar el plano del video
                    if (videoPlane) {
                        videoPlane.setAttribute('visible', true);
                    }
                    
                    // Cargar y reproducir video
                    if (video) {
                        if (video.readyState === 0) {
                            // Si el video no estÃ¡ cargado, cargarlo primero
                            video.load();
                            video.addEventListener('loadeddata', function() {
                                statusDiv.textContent = 'Â¡Reproduciendo video!';
                                video.play().catch(e => {
                                    console.log('Intentando reproducir sin sonido...');
                                    video.muted = true;
                                    video.play().catch(err => {
                                        console.error('Error reproduciendo video:', err);
                                        statusDiv.className = 'status error';
                                        statusDiv.textContent = 'Error reproduciendo video';
                                    });
                                });
                            }, { once: true });
                        } else {
                            // Video ya estÃ¡ cargado
                            statusDiv.textContent = 'Â¡Reproduciendo video!';
                            video.play().catch(e => {
                                console.log('Intentando reproducir sin sonido...');
                                video.muted = true;
                                video.play().catch(err => {
                                    console.error('Error reproduciendo video:', err);
                                    statusDiv.className = 'status error';
                                    statusDiv.textContent = 'Error reproduciendo video';
                                });
                            });
                        }
                    }
                });
                
                // Cuando se pierde el logotipo
                marker.addEventListener('markerLost', function() {
                    console.log('Logotipo perdido');
                    isMarkerVisible = false;
                    
                    // Ocultar estado
                    statusDiv.style.display = 'none';
                    
                    // Mostrar instrucciones
                    document.body.classList.remove('marker-found');
                    
                    // Ocultar el plano del video
                    if (videoPlane) {
                        videoPlane.setAttribute('visible', false);
                    }
                    
                    // Pausar video
                    if (video) {
                        video.pause();
                    }
                });
            }
        });
        
        // Manejo de errores de video
        if (video) {
            video.addEventListener('error', function(e) {
                console.error('Error cargando video:', e);
                const statusDiv = document.querySelector('#status');
                statusDiv.style.display = 'block';
                statusDiv.className = 'status error';
                statusDiv.textContent = 'Error cargando el video';
            });
        }
        
        // Verificar soporte de cÃ¡mara
        if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
            alert('Tu navegador no soporta acceso a la cÃ¡mara. Usa Chrome actualizado.');
        }
        
        // Manejo de orientaciÃ³n para mÃ³viles
        window.addEventListener('orientationchange', function() {
            setTimeout(() => {
                if (arScene && arScene.systems && arScene.systems.camera) {
                    arScene.systems.camera.tick();
                }
            }, 500);
        });
        
        // Prevenir zoom en iOS
        document.addEventListener('gesturestart', function(e) {
            e.preventDefault();
        });
        
        document.addEventListener('touchstart', function(e) {
            if (e.touches.length > 1) {
                e.preventDefault();
            }
        }, { passive: false });
    </script>
</body>
</html>